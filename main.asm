;
; pe21_ex5.asm
;
; Created: 10/2/2023 2:13:30 PM
; Author : tuan minh
;


; Replace with your application code
.ORG 0
.DEF TEMP0 = R16
.DEF TEMP1 = R17
.DEF DUTY_HOLDER0 = R19
.DEF DUTY_HOLDER1 = R18
.DEF TEMP_DUTY0 = R25
.DEF TEMP_DUTY1 = R24
; 40000 CYCLES = 0x9C40 CYCLES

DUTY_CYCLE100:
		LDI TEMP0, HIGH(RAMEND) ; INITIALIZED STACK POINTER
		OUT SPH, TEMP0
		LDI TEMP0, LOW(RAMEND)
		OUT SPL, TEMP0

		CLR TEMP0
		STS TCCR1A, TEMP0 ; RESET TIMER/COUNTER CONTROL REGISTER A
		STS TCCR1B, TEMP0 ; RESET TIMER/COUNTER CONTROL REGISTER B
		LDI TEMP0, 0x10
		OUT DDRB, TEMP0 ; CONFIGURE PB4 = OC0B AS OUTPUT
		CLR TEMP0
		CLR TEMP1
		OUT PORTB, TEMP0
		LDI DUTY_HOLDER0, 0x9C ; VALUE TO INIT OCR1A = 40000 for 0% duty cycle
		LDI DUTY_HOLDER1, 0x40
		CLR R21
		CLR R20

AGAIN:
		CBI PORTB, 4
		CALL DUTY_DEC ; ROUTINE TO DEC DUTY CYCLE 
		CALL DELAY_T1
		SBI PORTB, 4
		CALL DUTY_INC ; ROUTINE TO INC DUTY CYCLE
		CALL DELAY_T1
		CPI R20, 0x40 ; IF CYCLES REACHED MAXIMUM JMP TO DOWNLOOP
		BRNE AGAIN
		CPI R21, 0x9C
		BRNE AGAIN

		LDI R20, 0x00
		LDI R21, 0x00
		LDI DUTY_HOLDER0, 0x9C ; RESET CYCLE VALUE
		LDI DUTY_HOLDER1, 0x40 ; RESET CYCLE VALUE

DOWNLOOP:
		SBI PORTB, 4
		CALL DUTY_DEC ; ROUTINE TO REVERSE DEC DUTY CYCLE 
		CALL DELAY_T1
		CBI PORTB, 4
		CALL DUTY_INC ; ROUTINE TO REVERSE INC DUTY CYCLE
		CALL DELAY_T1
		CPI R20, 0x40 ; IF CYCLES REACHED MAXIMUM JMP TO START
		BRNE DOWNLOOP
		CPI R21, 0x9C
		BRNE DOWNLOOP

		RJMP DUTY_CYCLE100 ; AGAIN

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
DELAY_T1:
		LDI TEMP0, 0b00001001 ; CTC MODE, NO PRESCALER
		STS TCCR1B, TEMP0
		CLR TEMP0
		STS TCNT1H, TEMP0
		STS TCNT1L, TEMP0

DELAYT1_LOOP:
		SBIS TIFR1, OCF1A
		RJMP DELAYT1_LOOP 
		SBI TIFR1, OCF1A ; RESET TIMER1
		RET

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
DUTY_DEC:
		MOV TEMP_DUTY0, DUTY_HOLDER0 ; LOAD PRESENT HIGH DUTY VALUE FROM TEMP STORAGE
		MOV TEMP_DUTY1, DUTY_HOLDER1 ; LOAD PRESENT LOW DUTY VALUE FROM TEMP STORAGE
		STS OCR1AH, TEMP_DUTY0
		STS OCR1AL, TEMP_DUTY1
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		SBIW TEMP_DUTY0:TEMP_DUTY1, 40 ; DEC DUTY CYCLE BY 0.1%
		MOV DUTY_HOLDER0, TEMP_DUTY0 ; STORE NEW HIGH DUTY VALUE TO TEMP STORAGE
		MOV DUTY_HOLDER1, TEMP_DUTY1 ; STORE NEW LOW DUTY VALUE TO TEMP STORAGE
		RET

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
DUTY_INC:
		MOV TEMP_DUTY0, R21 ; LOAD PRESENT HIGH DUTY VALUE FROM TEMP STORAGE
		MOV TEMP_DUTY1, R20 ; LOAD PRESENT LOW DUTY VALUE FROM TEMP STORAGE
		STS OCR1AH, TEMP_DUTY0
		STS OCR1AL, TEMP_DUTY1
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		ADIW TEMP_DUTY0:TEMP_DUTY1, 40 ; INC DUTY CYCLE BY 0.1%
		MOV R21, TEMP_DUTY0 ; STORE NEW HIGH DUTY VALUE TO TEMP STORAGE
		MOV R20, TEMP_DUTY1 ; STORE NEW LOW DUTY VALUE TO TEMP STORAGE
		RET

